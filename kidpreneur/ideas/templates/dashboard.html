{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
  .dashboard-container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    padding: 20px;
    flex-wrap: wrap;
    transition: background 0.3s ease, color 0.3s ease;
  }

  /* Theme colors */
  .theme-yellow { background: #fffbea; color: #664d03; }
  .theme-blue { background: #e7f1ff; color: #084298; }
  .theme-green { background: #e9f7ef; color: #0f5132; }
  .theme-pink { background: #fde2e9; color: #702459; }
  .theme-purple { background: #f3e8ff; color: #4a148c; }
  .theme-orange { background: #fff4e5; color: #7c2d12; }
  .theme-danger { background: #f8d7da; color: #842029; }

  .tab-section {
    width: 3%;
    min-width: 80px;
  }

  .tab-scroll-wrapper {
    overflow-y: auto;
    max-height: 90vh;
  }

  .nav-tabs {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .nav-tabs .nav-link {
    text-align: center;
    padding: 10px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .profile-section {
    width: 70%;
  }

  .content-section {
    flex: 1;
    min-width: 250px;
  }

  .card-custom {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background-color: #fff;
    margin-bottom: 20px;
  }

  .profile .info-item {
    margin-bottom: 8px;
  }

  #updateFormContainer form {
    background: #f9f9f9;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  #updateFormContainer input,
  #updateFormContainer select {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
  }

  #updateFormContainer button {
    margin-top: 10px;
  }
</style>
{% endblock %}

{% block content %}
<!-- Add theme class dynamically later -->
<div class="dashboard-container" id="dashboardContainer">

  <!-- Tabs Section -->
  <div class="tab-section">
    <div class="tab-scroll-wrapper">
      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ideas">üí°</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#starred">‚≠ê</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#archived">üóÇÔ∏è</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#create">‚ûï</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#custom">üé®</button></li>
      </ul>
    </div>
  </div>

  <!-- Profile Section -->
  <div class="profile-section">
    <div class="card-custom profile">
      <h3>üë§ My Profile</h3>
      <div class="info-item"><b>Username:</b> {{ request.user.username }}</div>
      <div class="info-item"><b>Email:</b> {{ request.user.email }}</div>
      <div class="info-item"><b>First Name:</b> {{ request.user.first_name }}</div>
      <div class="info-item"><b>Last Name:</b> {{ request.user.last_name }}</div>
      <div class="info-item"><b>Phone:</b> {{ request.user.phone_number|default:"N/A" }}</div>
      <div class="info-item"><b>Date of Birth:</b> {{ request.user.dob|default:"N/A" }}</div>
      <div class="info-item"><b>Age:</b> {{ request.user.age|default:"N/A" }}</div>
      <div class="info-item"><b>Student:</b> {% if request.user.is_student %}Yes{% else %}No{% endif %}
      {% if request.user.is_student %}
        <div class="info-item"><b>School:</b> {{ request.user.school_name|default:"N/A" }}</div>
      {% endif %}
      <div class="mt-3">
        <button id="toggleUpdateForm" class="btn btn-outline-primary w-100">‚úèÔ∏è Update Profile</button>
      </div>
      <div id="updateFormContainer" style="display:none; margin-top:15px;">
        <form method="POST">
          {% csrf_token %}
          <input type="hidden" name="profile_update" value="1">
          {{ user_form.as_p }}
          <button type="submit" class="btn btn-outline-success w-100 mt-2">üíæ Save Changes</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Content Section -->
  <div class="content-section">
    <div class="tab-content p-3 card-custom">

      <!-- My Ideas -->
      <div class="tab-pane fade show active" id="ideas">
        <h3>üí° My Ideas</h3>
        {% for idea in ideas %}
          <div class="card-custom idea-card mb-3">
            <a href="{% url 'idea-detail' idea.slug %}" style="text-decoration:none; color: inherit;">
              <b><h2>{{ idea.title }}</h2></b>
              <p>{{ idea.description|truncatewords:15 }}</p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small>By <b>{{ idea.user.username }}</b> ‚Ä¢ {{ idea.created_at|date:"M d, Y" }}</small>
                <span>üëç {{ idea.likes.count }}</span>
              </div>
            </a>
            <div class="mt-2 d-flex gap-2">
              <a href="{% url 'idea_update' idea.slug %}" class="btn btn-sm btn-primary">Edit</a>
              <button class="btn btn-sm btn-warning open-action-modal" data-action="archive" data-id="{{ idea.id }}">Archive</button>
            </div>
          </div>
        {% empty %}
          <p>No ideas yet.</p>
        {% endfor %}
      </div>

      <!-- Starred Ideas -->
      <div class="tab-pane fade" id="starred">
        <h3>‚≠ê Starred Ideas</h3>
        {% for idea in starred_ideas %}
          <a href="{% url 'idea-detail' idea.slug %}" style="text-decoration:none">
            <div class="card-custom idea-card mb-3">
              <b><h2>{{ idea.title }}</h2></b>
              <p>{{ idea.description|truncatewords:15 }}</p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small>By <b>{{ idea.user.username }}</b> ‚Ä¢ {{ idea.created_at|date:"M d, Y" }}</small>
                <span>üëç {{ idea.likes.count }}</span>
              </div>
            </div>
          </a>
        {% empty %}
          <p>You haven‚Äôt starred any ideas yet.</p>
        {% endfor %}
      </div>

      <!-- Archived Ideas -->
      <div class="tab-pane fade" id="archived">
        <h3>üóÇÔ∏è Archived Ideas</h3>
        {% for idea in archived_ideas %}
          <div class="card-custom idea-card mb-3">
            <b><h2>{{ idea.title }}</h2></b>
            <p>{{ idea.description|truncatewords:15 }}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small>By <b>{{ idea.user.username }}</b> ‚Ä¢ {{ idea.created_at|date:"M d, Y" }}</small>
              <span>üëç {{ idea.likes.count }}</span>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-sm btn-warning open-action-modal" data-action="unarchive" data-id="{{ idea.id }}">Unarchive</button>
              <button class="btn btn-sm btn-danger open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
            </div>
          </div>
        {% empty %}
          <p>No archived ideas yet.</p>
        {% endfor %}
      </div>

      <!-- Create Idea -->
      <div class="tab-pane fade" id="create">
        <h3>‚ûï Create New Idea</h3>
        <br>
        <a href="{% url 'idea_create' %}" class="create-idea-card" style="text-decoration:none;">
          <div class="text">
            <h4>Create Your Next Idea</h4>
            <p>Click here to launch your creativity and share your idea with the world!</p>
          </div>
        </a>
      </div>

      <!-- Customization -->
      <div class="tab-pane fade" id="custom">
        <h3>üé® Customize Dashboard Theme</h3>
        <br>
        <form id="themeForm">
          <div class="mb-3">
            <label for="themeSelect" class="form-label"><b>Select Theme:</b></label>
            <select id="themeSelect" class="form-select">
              <option value="theme-yellow">Yellow</option>
              <option value="theme-blue">Blue</option>
              <option value="theme-green">Green</option>
              <option value="theme-pink">Pink</option>
              <option value="theme-purple">Purple</option>
              <option value="theme-orange">Orange</option>
              <option value="theme-danger">Red</option>
            </select>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Archive/Delete -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="actionForm" class="modal-content" action="javascript:void(0);">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="actionModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="idea_id" id="modalIdeaId">
        <input type="hidden" name="action" id="modalAction">
        <div class="mb-3">
          <label for="modalPassword" class="form-label">Enter Password:</label>
          <input type="password" name="password" id="modalPassword" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger" id="modalSubmitBtn">Confirm</button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const modal = new bootstrap.Modal(document.getElementById("actionModal"));
    const actionForm = document.getElementById("actionForm");

    // Apply theme from local storage
    const container = document.getElementById("dashboardContainer");
    const savedTheme = localStorage.getItem("dashboardTheme");
    if (savedTheme) {
      container.classList.add(savedTheme);
      document.getElementById("themeSelect").value = savedTheme;
    } else {
      container.classList.add("theme-yellow"); // default theme
    }

    // Theme change handler
    document.getElementById("themeSelect").addEventListener("change", (e) => {
      const newTheme = e.target.value;
      container.classList.forEach(cls => {
        if (cls.startsWith("theme-")) container.classList.remove(cls);
      });
      container.classList.add(newTheme);
      localStorage.setItem("dashboardTheme", newTheme);
      location.reload(); // Auto-refresh to apply changes to elements
    });

    // Profile form toggle
    document.getElementById("toggleUpdateForm").addEventListener("click", () => {
      const formContainer = document.getElementById("updateFormContainer");
      formContainer.style.display = formContainer.style.display === "none" ? "block" : "none";
    });

    // Action modal setup
    document.querySelectorAll(".open-action-modal").forEach(button => {
      button.addEventListener("click", () => {
        const ideaId = button.getAttribute("data-id");
        const action = button.getAttribute("data-action");

        document.getElementById("modalIdeaId").value = ideaId;
        document.getElementById("modalAction").value = action;
        document.getElementById("modalPassword").value = "";

        const actionCapitalized = action.charAt(0).toUpperCase() + action.slice(1);
        document.getElementById("actionModalLabel").textContent = `Confirm ${actionCapitalized}`;

        let btnText = "Confirm";
        if (action === "delete") btnText = "Delete";
        else if (action === "unarchive") btnText = "Unarchive";
        else btnText = "Archive";

        document.getElementById("modalSubmitBtn").textContent = btnText;

        modal.show();
      });
    });

    // Handle modal form submit
    actionForm.addEventListener("submit", async e => {
      e.preventDefault();
      const ideaId = document.getElementById("modalIdeaId").value;
      const action = document.getElementById("modalAction").value;
      const password = document.getElementById("modalPassword").value;
      const csrfToken = document.querySelector("#actionForm [name='csrfmiddlewaretoken']").value;

      const res = await fetch("/confirm-action/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken
        },
        body: new URLSearchParams({ action, idea_id: ideaId, password })
      });

      const data = await res.json();
      if (data.success) {
        alert(data.success);
        location.reload();
      } else {
        alert(data.error || "Something went wrong.");
      }
    });
  });
</script>
{% endblock %}

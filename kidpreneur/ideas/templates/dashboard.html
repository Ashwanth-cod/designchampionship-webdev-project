{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
  .dashboard-container {
    display: flex;
    flex-direction: row;
    gap: 20px;
    padding: 20px;
    flex-wrap: wrap;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .theme-yellow { background: #fffbea; color: #664d03; }
  .theme-blue   { background: #e7f1ff; color: #084298; }
  .theme-green  { background: #e9f7ef; color: #0f5132; }
  .theme-pink   { background: #fde2e9; color: #702459; }
  .theme-purple { background: #f3e8ff; color: #4a148c; }
  .theme-orange { background: #fff4e5; color: #7c2d12; }
  .theme-danger { background: #f8d7da; color: #842029; }

  .tab-section { width: 3%; min-width: 80px; }
  .tab-scroll-wrapper { overflow-y: auto; max-height: 90vh; }
  .nav-tabs { display: flex; flex-direction: column; gap: 10px; }
  .nav-tabs .nav-link { text-align: center; padding: 10px; white-space: nowrap; flex-shrink: 0; }
  .nav-tabs .nav-link.active { background-color: rgba(0,0,0,0.1); border-radius: 6px; }
  .content-section { flex: 1; min-width: 250px; }
  .card-custom { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: #fff; margin-bottom: 20px; }
  .idea-card { background-color: #ffffffb3; }
  .profile .info-item { margin-bottom: 8px; }
  .profile i { color: currentColor; vertical-align: middle; margin-right: 6px; }
  #updateFormContainer form { background: #f9f9f9; padding: 15px; border-radius: 8px; border: 1px solid #ccc; }
  #updateFormContainer input, #updateFormContainer select { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
  #updateFormContainer button { margin-top: 10px; }
  .action-btn { min-width: 80px; }
  .ideabtn { border-radius: 10px; border: 5px solid white; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container" id="dashboardContainer">
  <div class="tab-section">
    <div class="tab-scroll-wrapper">
      <ul class="nav nav-tabs" role="tablist" aria-orientation="vertical">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ideas" role="tab" aria-controls="ideas" title="My Ideas">💡</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#starred" role="tab" aria-controls="starred" title="Starred Ideas">⭐</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#archived" role="tab" aria-controls="archived" title="Archived Ideas">🗂️</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#create" role="tab" aria-controls="create" title="Create Idea">➕</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile" role="tab" aria-controls="profile" title="Profile">👤</button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#theme" role="tab" aria-controls="theme" title="Customize Theme">🎨</button>
        </li>
      </ul>
    </div>
  </div>

  <div class="content-section">
    <div class="tab-content p-3 card-custom">
      
      <!-- My Ideas -->
      <div class="tab-pane fade show active" id="ideas" role="tabpanel">
        <h1 style="text-align:center;">💡 My Ideas</h1>
        {% for idea in ideas %}
          <div class="card-custom idea-card mb-3">
            <a href="{% url 'idea-detail' idea.slug %}" style="text-decoration:none; color:inherit;">
              <h2><b>{{ idea.title }}</b></h2>
              <p>{{ idea.description|truncatewords:15 }}</p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small>Created at {{ idea.created_at|date:"M d, Y" }}</small>
                <span>👍 {{ idea.likes.count }}</span>
              </div>
            </a>
            <div class="mt-2 d-flex gap-2">
              <a href="{% url 'idea_update' idea.slug %}" class="btn ideabtn btn-sm btn-primary action-btn">Edit</a>
              <button class="btn ideabtn btn-sm btn-warning action-btn open-action-modal" data-action="archive" data-id="{{ idea.id }}">Archive</button>
              <button class="btn ideabtn btn-sm btn-danger action-btn open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
            </div>
          </div>
        {% empty %}
          <p>No ideas yet.</p>
        {% endfor %}
      </div>

      <!-- Starred Ideas -->
      <div class="tab-pane fade" id="starred" role="tabpanel">
        <h1 style="text-align:center;">⭐ Starred Ideas</h1>
        {% for idea in starred_ideas %}
          <a href="{% url 'idea-detail' idea.slug %}" style="text-decoration:none; color:inherit;">
            <div class="card-custom idea-card mb-3">
              <h2><b>{{ idea.title }}</b></h2>
              <p>{{ idea.description|truncatewords:15 }}</p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small>By <b>{{ idea.user.username }}</b> • {{ idea.created_at|date:"M d, Y" }}</small>
                <span>👍 {{ idea.likes.count }}</span>
              </div>
            </div>
          </a>
        {% empty %}
          <p>You haven’t starred any ideas yet.</p>
        {% endfor %}
      </div>

      <!-- Archived Ideas -->
      <div class="tab-pane fade" id="archived" role="tabpanel">
        <h1 style="text-align:center;">🗂️ Archived Ideas</h1>
        {% for idea in archived_ideas %}
          <div class="card-custom idea-card mb-3">
            <h2><b>{{ idea.title }}</b></h2>
            <p>{{ idea.description|truncatewords:15 }}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small>By <b>{{ idea.user.username }}</b> • {{ idea.created_at|date:"M d, Y" }}</small>
              <span>👍 {{ idea.likes.count }}</span>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button class="btn btn-sm btn-warning action-btn open-action-modal" data-action="unarchive" data-id="{{ idea.id }}">Unarchive</button>
              <button class="btn btn-sm btn-danger action-btn open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
            </div>
          </div>
        {% empty %}
          <p>No archived ideas yet.</p>
        {% endfor %}
      </div>

      <!-- Create Idea -->
      <div class="tab-pane fade" id="create" role="tabpanel">
        <h1 style="text-align:center;">➕ Create New Idea</h1>
        <a href="{% url 'idea_create' %}" class="create-idea-card" style="text-decoration:none;">
          <div class="text">
            <h4>Create Your Next Idea</h4>
            <p>Click here to launch your creativity and share your idea with the world!</p>
          </div>
        </a>
      </div>

      <!-- Profile -->
      <div class="tab-pane fade" id="profile" role="tabpanel">
        <h1 style="text-align:center;">👤 My Profile</h1>
        <div class="row g-3 mb-4">
          <div class="col-md-3">
            <div class="card-custom text-center">
              <i class="bi bi-lightbulb-fill fs-3"></i>
              <div><b>Total Ideas</b></div>
              <div>{{ ideas|length }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card-custom text-center">
              <i class="bi bi-star-fill fs-3"></i>
              <div><b>Starred</b></div>
              <div>{{ starred_ideas|length }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card-custom text-center">
              <i class="bi bi-archive-fill fs-3"></i>
              <div><b>Archived</b></div>
              <div>{{ archived_ideas|length }}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card-custom text-center">
              <i class="bi bi-hand-thumbs-up-fill fs-3"></i>
              <div><b>Total Likes</b></div>
              <div>{{ total_likes }}</div>
            </div>
          </div>
        </div>

        <div class="card-custom profile">
          <div class="info-item"><i class="bi bi-person-circle"></i><b>Username:</b> {{ request.user.username }}</div>
          <div class="info-item"><i class="bi bi-envelope"></i><b>Email:</b> {{ request.user.email }}</div>
          <div class="info-item"><i class="bi bi-calendar3"></i><b>Date Joined:</b> {{ request.user.date_joined|date:"M d, Y" }}</div>
          <div class="info-item"><i class="bi bi-pen"></i><b>Last Updated:</b> {{ request.user.last_login|date:"M d, Y" }}</div>
          
        </div>

        <button id="editProfileBtn" class="btn btn-outline-danger w-100">Edit Profile</button>

        <div id="updateFormContainer" class="mt-4" style="display:none;">
          <!-- Profile update form will be loaded here via JS if needed -->
        </div>
      </div>

      <!-- Customize Theme -->
      <div class="tab-pane fade" id="theme" role="tabpanel">
        <h1 style="text-align:center;">🎨 Customize Theme</h1>
        <div class="card-custom text-center mt-4">
          <label for="themeSelect"><b>Choose your theme:</b></label>
          <select id="themeSelect" class="form-select w-auto mx-auto">
            <option value="theme-yellow">Yellow</option>
            <option value="theme-blue">Blue</option>
            <option value="theme-green">Green</option>
            <option value="theme-pink">Pink</option>
            <option value="theme-purple">Purple</option>
            <option value="theme-orange">Orange</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal for delete/archive/unarchive confirmation -->
<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="confirmActionForm" method="post" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="actionModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="actionModalBody"></div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("dashboardContainer");
  const themeSelect = document.getElementById("themeSelect");

  // Load theme from localStorage, default to 'theme-yellow'
  const savedTheme = localStorage.getItem("dashboardTheme") || "theme-yellow";

  // Apply the saved theme immediately
  container.classList.add(savedTheme);
  themeSelect.value = savedTheme;

  themeSelect.addEventListener("change", () => {
    const newTheme = themeSelect.value;

    // Remove any existing theme class (those starting with 'theme-')
    container.classList.forEach(cls => {
      if (cls.startsWith("theme-")) container.classList.remove(cls);
    });

    themeSelect.addEventListener("change", () => {
  const newTheme = themeSelect.value;

  // Remove any existing theme class (those starting with 'theme-')
  container.classList.forEach(cls => {
    if (cls.startsWith("theme-")) container.classList.remove(cls);
  });

  // Add the newly selected theme class
  container.classList.add(newTheme);

  // Save it in localStorage to persist across reloads
  localStorage.setItem("dashboardTheme", newTheme);

  // Auto-refresh the page to apply theme server-side if needed
  location.reload();
});


    // Add the newly selected theme class
    container.classList.add(newTheme);

    // Save it in localStorage to persist across reloads
    localStorage.setItem("dashboardTheme", newTheme);
  });

  // Action modal logic (delete/archive/unarchive)
  const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
  const confirmActionForm = document.getElementById('confirmActionForm');
  const actionModalBody = document.getElementById('actionModalBody');
  const confirmActionBtn = document.getElementById('confirmActionBtn');

  let currentAction = null, currentIdeaId = null;

  document.querySelectorAll(".open-action-modal").forEach(btn => {
    btn.addEventListener("click", (e) => {
      currentAction = e.currentTarget.dataset.action;
      currentIdeaId = e.currentTarget.dataset.id;

      let msg = "";
      confirmActionBtn.classList.toggle("btn-danger", currentAction === "delete");
      confirmActionBtn.classList.toggle("btn-warning", currentAction !== "delete");

      if (currentAction === "delete") msg = "Are you sure you want to <b>delete</b> this idea?";
      else if (currentAction === "archive") msg = "Are you sure you want to <b>archive</b> this idea?";
      else if (currentAction === "unarchive") msg = "Are you sure you want to <b>unarchive</b> this idea?";
      else msg = "Confirm your action.";

      actionModalBody.innerHTML = msg;

      // Add confirmation button directly into the modal body
      actionModalBody.innerHTML += `
        <div class="mt-3">
        </div>
      `;

      actionModal.show();
    });
  });

  confirmActionForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    confirmActionBtn.disabled = true;
    confirmActionBtn.textContent = "Processing...";

    try {
      const response = await fetch("{% url 'idea_action' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({
          action: currentAction,
          idea_id: currentIdeaId
        }),
      });

      if (response.ok) {
        location.reload(); // Refresh the page if the action was successful
      } else {
        const errorData = await response.json();
        alert(`Error: ${errorData.error || 'An error occurred.'}`);
      }
    } catch {
      alert("Network error. Please try again.");
    } finally {
      confirmActionBtn.disabled = false;
      confirmActionBtn.textContent = "Confirm";
      actionModal.hide();
    }
  });
});

</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
   body {
    background: url("{% static 'images/doodle-bg2.png' %}"); 
    background-size: 300px 300px; 
  }

  .card-custom {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    background-color: #fff;
    box-sizing: border-box;
    width: 100%;
    transition: all 0.2s ease-in-out;
  }
  .idea-card {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
  }
  .ideabtn {
    border-radius: 10px;
    border: 2px solid white;
  }
  @media (max-width: 576px) {
    .card-custom h2 { font-size: 1.2rem; }
    .card-custom p { font-size: 0.9rem; }
  }
  .user-avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }
  .user-details h5 { margin:0; font-size:1.1rem; }
  .user-details p { margin:0; }
  .user-details .text-muted { font-size:0.9rem; }
  .user-details .text-success { color:#28a745 !important; }
  .user-details .text-danger { color:#dc3545 !important; }
  @media (max-width: 768px) {
    .user-avatar img { width: 40px; height: 40px; } 
  }
  .user-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 10px;
    background: #000000;
    height: 100%;
  }
  .nav-link-tabs {
    width:145px;
    text-align: left;
  }

  /* ===============================
     THEME STYLES
     =============================== */
  .theme-yellow {
    background-color: #eaffea;
    color: #664d00;
  }
  .theme-blue {
    background-color: #eaffea;
    color: #002855;
  }
  .theme-green {
    background-color: #eaffea;
    color: #004d1a;
  }
  .theme-pink {
    background-color: #ffe6f0;
    color: #660033;
  }
  .theme-purple {
    background-color: #f6e6ff;
    color: #3d0066;
  }
  .theme-orange {
    background-color: #fff0e6;
    color: #663300;
  }

  /* make sure text in cards stays readable */
  .dashboard-container .card-custom {
    background: #fff;
    color: #000;
  }
  .nav-tabs .nav-link.active {
  color: #495057;
  background-color: #fff;   /* ‚Üê forces white background */
  border-color: #dee2e6 #dee2e6 #fff;
}
/* Override Bootstrap active state for your sidebar tabs */
.nav-link-tabs.active {
  background-color: #000 !important;   /* pick a universal background, or theme color */
  color: #fff !important;
  border-radius: 8px;
  font-weight: bold;
}

/* Normal state */
.nav-link-tabs {
  background: transparent;
  color: #000;
  border: none;
  text-align: left;
  padding: 10px 15px;
  transition: background 0.2s ease;
}

/* Hover effect */
.nav-link-tabs:hover {
  background-color: rgba(0, 0, 0, 0.05);
}
  
</style>
{% endblock %}


{% block content %}
<div id="dashboardContainer" class="dashboard-container d-flex">
  <div class="tab-section">
    <div class="tab-scroll-wrapper">
      <ul class="nav nav-tabs flex-column" role="tablist" aria-orientation="vertical">
        <li class="nav-item"><button class="nav-link nav-link-tabs active" data-bs-toggle="tab" data-bs-target="#ideas" role="tab" title="My Ideas">üí° My Ideas</button></li>
        <li class="nav-item"><button class="nav-link nav-link-tabs" data-bs-toggle="tab" data-bs-target="#starred" role="tab" title="Starred Ideas">‚≠êStarred</button></li>
        <li class="nav-item"><button class="nav-link nav-link-tabs" data-bs-toggle="tab" data-bs-target="#archived" role="tab" title="Archived Ideas">üóÇÔ∏è Archived</button></li>
        <li class="nav-item"><button class="nav-link nav-link-tabs" data-bs-toggle="tab" data-bs-target="#create" role="tab" title="Create Idea">‚ûï Create</button></li>
        <li class="nav-item"><button class="nav-link nav-link-tabs" data-bs-toggle="tab" data-bs-target="#profile" role="tab" title="Profile">üë§ Profile</button></li>
        <li class="nav-item"><button class="nav-link nav-link-tabs" data-bs-toggle="tab" data-bs-target="#messages" role="tab" title="Messages">üí¨ Message</button></li>
        <li class="nav-item"><button class="nav-link nav-link-tabs" data-bs-toggle="tab" data-bs-target="#theme" role="tab" title="Customize Theme">üé® Customize</button></li>
      </ul>
    </div>
  </div>

  <div class="content-section flex-grow-1">
    <div class="tab-content p-3">

      <div class="tab-pane fade show active" id="ideas" role="tabpanel">
        <h1 class="text-center mb-4">üí° My Ideas</h1>
        <div class="row">
          {% for idea in ideas %}
          <div class="col-12 col-sm-12 col-md-6 col-lg-4 mb-4">
            <div class="card-custom idea-card h-100 d-flex flex-column">
              <a href="{% url 'idea-detail' idea.slug %}" class="text-decoration-none text-dark">
                <h2><b>{{ idea.title }}</b></h2>
                <p>{{ idea.description|truncatewords:15 }}</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span>üëç {{ idea.likes.count }}</span>
                </div>
              </a>
              <div class="mt-3 d-flex gap-2">
                <a href="{% url 'idea_update' idea.slug %}" class="btn ideabtn btn-sm btn-primary w-100">Edit</a>
                <button class="btn ideabtn btn-sm btn-warning w-100 open-action-modal" data-action="archive" data-id="{{ idea.id }}">Archive</button>
                <button class="btn ideabtn btn-sm btn-danger w-100 open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
              </div>
            </div>
          </div>
          {% empty %}<p>No ideas yet.</p>{% endfor %}
        </div>
      </div>

      <div class="tab-pane fade" id="starred" role="tabpanel">
        <h1 class="text-center mb-4">‚≠ê Starred Ideas</h1>
        <div class="row">
          {% for idea in starred_ideas %}
          <div class="col-12 col-sm-12 col-md-6 col-lg-4 mb-4">
            <a href="{% url 'idea-detail' idea.slug %}" class="text-decoration-none text-dark">
              <div class="card-custom idea-card h-100">
                <h2><b>{{ idea.title }}</b></h2>
                <p>{{ idea.description|truncatewords:15 }}</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <small>By <b>{{ idea.created_by.username }}</b> ‚Ä¢ {{ idea.created_at|date:"M d, Y" }}</small>
                  <span>üëç {{ idea.likes.count }}</span>
                </div>
              </div>
            </a>
          </div>
          {% empty %}<p>You haven‚Äôt starred any ideas yet.</p>{% endfor %}
        </div>
      </div>

      <div class="tab-pane fade" id="archived" role="tabpanel">
        <h1 class="text-center mb-4">üóÇÔ∏è Archived Ideas</h1>
        <div class="row">
          {% for idea in archived_ideas %}
          <div class="col-12 col-sm-12 col-md-6 col-lg-4 mb-4">
            <div class="card-custom idea-card h-100 d-flex flex-column">
              <h2><b>{{ idea.title }}</b></h2>
              <p>{{ idea.description|truncatewords:15 }}</p>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <small>By <b>{{ idea.created_by.username }}</b> ‚Ä¢ {{ idea.created_at|date:"M d, Y" }}</small>
                <span>üëç {{ idea.likes.count }}</span>
              </div>
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-sm btn-warning w-100 open-action-modal" data-action="unarchive" data-id="{{ idea.id }}">Unarchive</button>
                <button class="btn btn-sm btn-danger w-100 open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
              </div>
            </div>
          </div>
          {% empty %}<p>No archived ideas yet.</p>{% endfor %}
        </div>
      </div>

      <div class="tab-pane fade" id="create" role="tabpanel">
        <h1 class="text-center mb-4">‚ûï Create New Idea</h1>
        <a href="{% url 'idea_create' %}" class="create-idea-card text-decoration-none">
          <div class="card-custom text-center">
            <h4>Create Your Next Idea</h4>
            <p>Click here to launch your creativity and share your idea with the world!</p>
          </div>
        </a>
      </div>

      <div class="tab-pane fade" id="profile" role="tabpanel">
        <h1 class="text-center mb-4">üë§ My Profile</h1>
        <div class="row mb-4 text-center">
          {% for stat_name, stat_icon, stat_value in stats %}
          <div class="col-6 col-md-3 mb-2">
            <div class="card-custom p-3">
              <i class="bi {{ stat_icon }} mb-1" style="font-size:1.5rem;"></i>
              <h5 class="mb-0"><b>{{ stat_value }}</b></h5>
              <small>{{ stat_name }}</small>
            </div>
          </div>
          {% endfor %}
        </div>
        <div class="text-center mb-3">
          <button class="btn btn-primary" type="button" data-bs-toggle="collapse" data-bs-target="#profileUpdateForm" aria-expanded="false" aria-controls="profileUpdateForm">
            Update Profile
          </button>
        </div>
        <div class="collapse" id="profileUpdateForm">
          <div class="card-custom p-3 mb-4">
            <h2 class="mb-3">Update Profile</h2>
            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              <input type="hidden" name="profile_update_form" value="1">
              {{ profile_update_form.as_p }}
              <button type="submit" class="btn btn-success">Save Changes</button>
            </form>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-md-6 mb-4">
            <h2>Followers</h2>
            <div class="column">
              {% for follower in followers %}
              <div class="col-12 col-sm-6 col-md-4 mb-3">
                <div class="card-custom p-3 d-inline-flex align-items-center me-2 mb-2">
                  <div class="user-avatar me-3">
                    <img src="{% if follower.profile_picture %}{{ follower.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" alt="Avatar">
                  </div>
                  <div class="user-details">
                    <h5><b>{{ follower.username }}</b></h5>
                    <!--p class="text-muted">{{ follower.email }}</p>
                    <p class="small text-muted">Joined: {{ follower.date_joined|date:"M d, Y" }}</p-->
                    <p class="small {% if follower in following %}text-success{% else %}text-danger{% endif %}">
                      {% if follower in following %}Mutual Follower{% else %}Not Following Back{% endif %}
                    </p>
                  </div>
                </div>
              </div>
              {% empty %}<p>No followers yet.</p>{% endfor %}
            </div>
          </div>
          <div class="col-12 col-md-6 mb-4">
            <h2>Following</h2>
            <div class="column">
              {% for user in following %}
              <div class="col-12 col-sm-6 col-md-4 mb-3">
                <div class="card-custom p-3 d-inline-flex align-items-center me-2 mb-2 w-auto">
                  <div class="user-avatar me-3">
                    <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}{% static 'images/default-avatar.png' %}{% endif %}" alt="Avatar">
                  </div>
                  <div class="user-details">
                    <h5><b>{{ user.username }}</b></h5>
                    <!--p class="text-muted">{{ user.email }}</p>
                    <p class="small text-muted">Joined: {{ user.date_joined|date:"M d, Y" }}</p-->
                    <p class="small {% if user in followers %}text-success{% else %}text-danger{% endif %}">
                      {% if user in followers %}Mutual Follower{% else %}Not Following Back{% endif %}
                    </p>
                  </div>
                </div>
              </div>
              {% empty %}<p>You are not following anyone yet.</p>{% endfor %}
            </div>
          </div>
        </div>
      </div>


      <div class="tab-pane fade" id="messages" role="tabpanel">
  <h1 class="text-center mb-4">üí¨ Messages</h1>
  <div class="text-center mb-3">
    <!-- Compose New Message Button -->
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeModal">
      ‚úâÔ∏è Compose New Message
    </button>
  </div>

  {% if conversations %}
    <div class="list-group">
      {% for convo in conversations %}
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><b>Conversation with:</b>
              {% if convo.user2 == user %}
                {{ convo.user1.username }}
              {% else %}
                {{ convo.user2.username }}
              {% endif %}
            </span>
            {% if unread_counts %}
              <span class="badge bg-danger">{{ unread_counts|dict_get:convo.id }}</span>
            {% endif %}
          </div>

          <div class="card-body" style="max-height:300px; overflow-y:auto;">
            {% for msg in conversation_messages|dict_get:convo.id %}
              {% if msg.sender == user %}
                <div class="text-end mb-2">
                  <span class="badge bg-primary">You</span>
                  <p>{{ msg.text }}</p>
                  <small class="text-muted">{{ msg.timestamp|date:"M d, Y H:i" }}</small>
                </div>
              {% else %}
                <div class="text-start mb-2">
                  <span class="badge bg-secondary">{{ msg.sender.username }}</span>
                  <p>{{ msg.text }}</p>
                  <small class="text-muted">{{ msg.timestamp|date:"M d, Y H:i" }}</small>
                </div>
              {% endif %}
            {% empty %}
              <p>No messages in this conversation yet.</p>
            {% endfor %}
          </div>

          <div class="card-footer">
            <button class="btn btn-sm btn-success" 
                    data-bs-toggle="modal" 
                    data-bs-target="#composeModal"
                    onclick="document.getElementById('recipient_id').value = '{% if convo.user2 == user %}{{ convo.user1.id }}{% else %}{{ convo.user2.id }}{% endif %}'">
              Reply
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-center">You don‚Äôt have any message threads yet.</p>
  {% endif %}
</div>



      <div class="tab-pane fade" id="theme" role="tabpanel">
        <h1 class="text-center mb-4">üé® Customize Theme</h1>
        <div class="card-custom text-center p-3">
          <label for="themeSelect"><b>Choose your theme:</b></label>
          <select id="themeSelect" class="form-select w-100 mt-2">
            <option value="theme-yellow">Yellow</option>
            <option value="theme-blue">Blue</option>
            <option value="theme-green">Green</option>
            <option value="theme-pink">Pink</option>
            <option value="theme-purple">Purple</option>
            <option value="theme-orange">Orange</option>
          </select>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content shadow">
      <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="send_message_form" value="1">
        <div class="modal-header border-0">
          <h5 class="modal-title fw-bold">‚úâÔ∏è New Message</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="recipient_id" class="form-label">Recipient</label>
            <select id="recipient_id" name="recipient_id" class="form-select" required>
              <option value="" disabled selected>Select recipient</option>
              {% for user in following %}
                <option value="{{ user.id }}">{{ user.username|default:user.email }}</option>
              {% empty %}
                <!--option value="" disabled>No mutual followers available</option-->
                <option value="" disabled>Follow to get recipient</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="subject" class="form-label">Subject</label>
            <input type="text" id="subject" name="subject" class="form-control" placeholder="Optional">
          </div>
          <div class="mb-3">
            <label for="message_text" class="form-label">Message</label>
            <textarea id="message_text" name="text" class="form-control" rows="5" placeholder="Write your message..." required></textarea>
          </div>
          <div class="mb-3">
            <label for="attachment" class="form-label">Attachment</label>
            <input type="file" id="attachment" name="attachment" class="form-control">
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-success px-4">Send</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="confirmActionForm" method="post" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 id="actionModalLabel" class="modal-title">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="actionModalBody"></div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("dashboardContainer");
  const themeSelect = document.getElementById("themeSelect");

  // Apply saved theme
  const savedTheme = localStorage.getItem("dashboardTheme") || "theme-blue";
  container.classList.add(savedTheme);
  themeSelect.value = savedTheme;

  // Change theme on select
  themeSelect.addEventListener("change", () => {
    // Remove any old theme classes
    Array.from(container.classList).forEach(cls => { 
      if (cls.startsWith("theme-")) container.classList.remove(cls); 
    });

    // Add new theme
    container.classList.add(themeSelect.value);

    // Save in localStorage
    localStorage.setItem("dashboardTheme", themeSelect.value);
    location.reload();
  });

  const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
  const confirmActionForm = document.getElementById('confirmActionForm');
  const actionModalBody = document.getElementById('actionModalBody');
  const confirmActionBtn = document.getElementById('confirmActionBtn');
  let currentAction, currentIdeaId;

  document.querySelectorAll(".open-action-modal").forEach(btn => {
    btn.addEventListener("click", e => {
      currentAction = e.currentTarget.dataset.action;
      currentIdeaId = e.currentTarget.dataset.id;
      confirmActionBtn.className = "btn " + (currentAction === "delete" ? "btn-danger" : "btn-warning");
      actionModalBody.innerHTML = currentAction === "delete"
        ? "Are you sure you want to <b>delete</b> this idea?"
        : currentAction === "archive"
          ? "Are you sure you want to <b>archive</b> this idea?"
          : "Are you sure you want to <b>unarchive</b> this idea?";
      actionModal.show();
    });
  });

  confirmActionForm.addEventListener("submit", async e => {
    e.preventDefault();
    confirmActionBtn.disabled = true;
    confirmActionBtn.textContent = "Processing...";
    try {
      const res = await fetch("{% url 'idea_action' %}", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}" },
        body: JSON.stringify({ action: currentAction, idea_id: currentIdeaId })
      });
      if (res.ok) location.reload();
      else {
        const err = await res.json();
        alert(`Error: ${err.error || 'An error occurred.'}`);
      }
    } catch {
      alert("Network error. Please try again.");
    } finally {
      confirmActionBtn.disabled = false;
      confirmActionBtn.textContent = "Confirm";
      actionModal.hide();
    }
  });
});
</script>
{% endblock %}

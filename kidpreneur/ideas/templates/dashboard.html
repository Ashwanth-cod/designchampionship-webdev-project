{% extends "base.html" %}
{% load static %}
{% load custom_tags %}
{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<style>
.card-custom { transition: all 0.2s ease-in-out; }
.collapse.show { margin-top: 0.5rem; }
.chat-box { max-height: 300px; overflow-y: auto; background: #f9f9f9; border-radius: 8px; padding: 1rem; transition: background-color 0.2s ease-in-out; font-size: 0.95rem; }
.dashboard-container { display: flex; flex-direction: row; gap: 20px; padding: 20px; flex-wrap: wrap; transition: background 0.3s ease, color 0.3s ease;}

.tab-section { width: 3%; min-width: 80px; }
.tab-scroll-wrapper { overflow-y: auto; max-height: 90vh; }
.nav-tabs { display: flex; flex-direction: column; gap: 10px; }
.nav-tabs .nav-link { text-align: center; padding: 10px; white-space: nowrap; flex-shrink: 0; }
.nav-tabs .nav-link.active { background-color: rgba(0,0,0,0.1); border-radius: 6px; }
.compose-btn-container { position: sticky; top: 0; background: #fff; padding: 0.5rem 0; z-index: 10; }
.action-btn { border: 5px solid white}

.tab-pane{ width: 75% !important; max-width: 75% }
 
#composeModal .modal-content { border-radius: 12px; padding: 5px; }
#composeModal .form-control { border-radius: 8px; }
#composeModal textarea { resize: none; }
#composeModal .btn { border-radius: 8px; font-weight: 500; }
.card-custom {
  width: 100%;
  transition: all 0.2s ease-in-out;
}

.idea-card,
.profile,
.card-custom.text-center {
  width: 100%;
}


</style>
{% endblock %}

{% block content %}
<div class="dashboard-container" id="dashboardContainer">
  <div class="tab-section">
    <div class="tab-scroll-wrapper">
      <ul class="nav nav-tabs" role="tablist" aria-orientation="vertical">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#ideas" role="tab" aria-controls="ideas" title="My Ideas">💡</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#starred" role="tab" aria-controls="starred" title="Starred Ideas">⭐</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#archived" role="tab" aria-controls="archived" title="Archived Ideas">🗂️</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#create" role="tab" aria-controls="create" title="Create Idea">➕</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#profile" role="tab" aria-controls="profile" title="Profile">👤</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#messages" role="tab" aria-controls="messages" title="Messages">💬</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#theme" role="tab" aria-controls="theme" title="Customize Theme">🎨</button></li>
      </ul>
    </div>
  </div>

  <div class="content-section">
    <div class="tab-content p-3 card-custom">

      <div class="tab-pane fade show active" id="ideas" role="tabpanel">
        <h1 style="text-align:center;">💡 My Ideas</h1>
        {% for idea in ideas %}
        <div class="card-custom idea-card mb-3">
          <a href="{% url 'idea-detail' idea.slug %}" style="text-decoration:none; color:inherit;">
            <h2><b>{{ idea.title }}</b></h2>
            <p>{{ idea.description|truncatewords:15 }}</p>
            <div class="d-flex justify-content-between align-items-left mt-2"
              <small>By<span><b>{{ idea.created_by.username }}</b></span></small>
              <span>👍 {{ idea.likes.count }}</span>
            </div>
          </a>
          <div class="mt-2 d-flex gap-2">
            <a href="{% url 'idea_update' idea.slug %}" class="btn ideabtn btn-sm btn-primary action-btn">Edit</a>
            <button class="btn ideabtn btn-sm btn-warning action-btn open-action-modal" data-action="archive" data-id="{{ idea.id }}">Archive</button>
            <button class="btn ideabtn btn-sm btn-danger action-btn open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
          </div>
        </div>
        {% empty %} 
        <p>No ideas yet.</p>
        {% endfor %}
      </div>

      <div class="tab-pane fade" id="starred" role="tabpanel">
        <h1 style="text-align:center;">⭐ Starred Ideas</h1>
        {% for idea in starred_ideas %}
        <a href="{% url 'idea-detail' idea.slug %}" style="text-decoration:none; color:inherit;">
          <div class="card-custom idea-card mb-3">
            <h2><b>{{ idea.title }}</b></h2>
            <p>{{ idea.description|truncatewords:15 }}</p>
            <div class="d-flex justify-content-between align-items-center mt-2">
              <small>By <b>{{ idea.created_by.username }}</b> • {{ idea.created_at|date:"M d, Y" }}</small>
              <span>👍 {{ idea.likes.count }}</span>
            </div>
          </div>
        </a>
        {% empty %}
        <p>You haven’t starred any ideas yet.</p>
        {% endfor %}
      </div>

      <div class="tab-pane fade" id="archived" role="tabpanel">
        <h1 style="text-align:center;">🗂️ Archived Ideas</h1>
        {% for idea in archived_ideas %}
        <div class="card-custom idea-card mb-3">
          <h2><b>{{ idea.title }}</b></h2>
          <p>{{ idea.description|truncatewords:15 }}</p>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small>By <b>{{ idea.created_by.username }}</b> • {{ idea.created_at|date:"M d, Y" }}</small>
            <span>👍 {{ idea.likes.count }}</span>
          </div>
          <div class="mt-2 d-flex gap-2">
            <button class="btn btn-sm btn-warning action-btn open-action-modal" data-action="unarchive" data-id="{{ idea.id }}">Unarchive</button>
            <button class="btn btn-sm btn-danger action-btn open-action-modal" data-action="delete" data-id="{{ idea.id }}">Delete</button>
          </div>
        </div>
        {% empty %}
        <p>No archived ideas yet.</p>
        {% endfor %}
      </div>

      <div class="tab-pane fade" id="create" role="tabpanel">
        <h1 style="text-align:center;">➕ Create New Idea</h1>
        <a href="{% url 'idea_create' %}" class="create-idea-card" style="text-decoration:none;">
          <div class="text">
            <h4>Create Your Next Idea</h4>
            <p>Click here to launch your creativity and share your idea with the world!</p>
          </div>
        </a>
      </div>

      <div class="tab-pane fade" id="profile" role="tabpanel">
        <h1 style="text-align:center;">👤 My Profile</h1>
        <div class="d-flex flex-wrap gap-3 justify-content-start mb-4">
  <div class="card-custom text-center flex-fill" style="min-width: 200px;">
    <i class="bi bi-lightbulb-fill fs-3"></i>
    <div><b>Total Ideas</b></div>
    <div>{{ ideas|length }}</div>
  </div>
  <div class="card-custom text-center flex-fill" style="min-width: 200px;">
    <i class="bi bi-star-fill fs-3"></i>
    <div><b>Starred</b></div>
    <div>{{ starred_ideas|length }}</div>
  </div>
  <div class="card-custom text-center flex-fill" style="min-width: 200px;">
    <i class="bi bi-archive-fill fs-3"></i>
    <div><b>Archived</b></div>
    <div>{{ archived_ideas|length }}</div>
  </div>
  <div class="card-custom text-center flex-fill" style="min-width: 200px;">
    <i class="bi bi-hand-thumbs-up-fill fs-3"></i>
    <div><b>Total Likes</b></div>
    <div>{{ total_likes }}</div>
  </div>
</div>


        <div class="card-custom profile">
          <div class="info-item"><i class="bi bi-person-circle"></i><b>Username:</b> {{ request.user.username }}</div>
          <div class="info-item"><i class="bi bi-envelope"></i><b>Email:</b> {{ request.user.email }}</div>
          <div class="info-item"><i class="bi bi-calendar3"></i><b>Date Joined:</b> {{ request.user.date_joined|date:"M d, Y" }}</div>
        </div>

        <button id="editProfileBtn" class="btn btn-outline-danger w-100">Edit Profile</button>

        <div id="updateFormContainer" class="mt-4" style="display:none;"></div>
      </div>

  <div class="tab-pane fade" id="messages" role="tabpanel" style="padding: 20px;">
    <h1 class="text-center mb-4">📧 Messages</h1>

  <div class="d-flex justify-content-end mb-3" style="position: sticky; top: 0; background: #fff; padding: 10px 0; z-index: 10;">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#composeModal">✉️ Compose</button>
  </div>

  {% for convo in conversations %}
  <div class="card-custom mb-4" style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);">
    <h5 class="mb-2 d-flex justify-content-between align-items-center">
      <span onclick="toggleThread('{{ convo.id }}')" style="cursor: pointer; font-weight: 600;">
        {% if convo.subject %}
          {{ convo.subject }}
        {% else %}
          (No Subject)
        {% endif %}
        — with
        {% if convo.user1 != request.user %}
          {{ convo.user1.username }}
        {% else %}
          {{ convo.user2.username }}
        {% endif %}
      </span>
      {% with unread_counts|get_item:convo.id as unread %}
        {% if unread and unread > 0 %}
          <span class="badge bg-danger" style="font-size: 0.8rem;">{{ unread }} unread</span>
        {% endif %}
      {% endwith %}
    </h5>

    <div id="thread-{{ convo.id }}" class="thread-content" style="display: none; opacity: 0; transition: opacity 0.25s ease;">
      <div class="chat-box p-3" style="min-height:150px; max-height:300px; overflow-y:auto; background:#f9f9f9; border-radius:8px;">
        {% with conversation_messages|get_item:convo.id as messages %}
          {% for msg in messages %}
          <div class="mb-2 {% if msg.sender == request.user %}text-end{% else %}text-start{% endif %}">
            <div class="d-inline-block p-2 rounded {% if msg.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %}" style="max-width: 80%; word-wrap: break-word;">
              <div class="small fw-bold mb-1">
                {{ msg.sender.username|default:msg.sender.email }}
              </div>
              {% if msg.subject_override %}
                <strong>{{ msg.subject_override }}</strong><br>
              {% endif %}
              {{ msg.text|linebreaks }}
              {% if msg.attachment %}
                <br><a href="{{ msg.attachment.url }}" target="_blank" class="text-decoration-underline">📎 Attachment</a>
              {% endif %}
              <div class="small text-muted mt-1" style="font-size: 0.75rem;">
                {{ msg.timestamp|date:"M d, H:i" }}
              </div>
            </div>
          </div>
          {% empty %}
          <p class="text-muted m-0">No messages yet.</p>
          {% endfor %}
        {% endwith %}
      </div>

      <form method="post" enctype="multipart/form-data" class="mt-3 border-top pt-2">
        {% csrf_token %}
        <input type="hidden" name="conversation_id" value="{{ convo.id }}">
        <input type="hidden" name="send_message_form" value="1">
        <div class="mb-2">
          <input type="text" name="subject" class="form-control" placeholder="Subject (optional)">
        </div>
        <div class="input-group">
          {{ message_form.text }}
          <input type="file" name="attachment" class="form-control">
          <button type="submit" class="btn btn-success">Reply</button>
        </div>
      </form>
    </div>
  </div>
  {% empty %}
  <p class="text-muted fst-italic">No conversations yet. Start one now!</p>
  {% endfor %}
</div>


      <div class="tab-pane fade" id="theme" role="tabpanel">
        <h1 style="text-align:center;">🎨 Customize Theme</h1>
        <div class="card-custom text-center mt-4">
          <label for="themeSelect"><b>Choose your theme:</b></label>
          <select id="themeSelect" class="form-select w-100 mx-auto">
            <option value="theme-yellow">Yellow</option>
            <option value="theme-blue">Blue</option>
            <option value="theme-green">Green</option>
            <option value="theme-pink">Pink</option>
            <option value="theme-purple">Purple</option>
            <option value="theme-orange">Orange</option>
          </select>
        </div>
      </div>

    </div>
  </div>
</div>


  <!-- Compose Modal -->
  <div class="modal fade" id="composeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content shadow">
        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" name="send_message_form" value="1">
          <div class="modal-header border-0">
            <h5 class="modal-title fw-bold">✉️ New Message</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="recipient_username" class="form-label">Recipient Username</label>
              <input type="text" id="recipient_username" name="recipient_username" class="form-control" placeholder="Enter recipient’s username" required>
            </div>
            <div class="mb-3">
              <label for="subject" class="form-label">Subject</label>
              <input type="text" id="subject" name="subject" class="form-control" placeholder="Optional">
            </div>
            <div class="mb-3">
              <label for="message_text" class="form-label">Message</label>
              <textarea id="message_text" name="text" class="form-control" rows="5" placeholder="Write your message..." required></textarea>
            </div>
            <div class="mb-3">
              <label for="attachment" class="form-label">Attachment</label>
              <input type="file" id="attachment" name="attachment" class="form-control">
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-success px-4">Send</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>


<div class="modal fade" id="actionModal" tabindex="-1" aria-labelledby="actionModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="confirmActionForm" method="post" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="actionModalLabel">Confirm Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="actionModalBody"></div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-danger" id="confirmActionBtn">Confirm</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("dashboardContainer");
  const themeSelect = document.getElementById("themeSelect");
  const savedTheme = localStorage.getItem("dashboardTheme") || "theme-yellow";
  container.classList.add(savedTheme);
  themeSelect.value = savedTheme;
  themeSelect.addEventListener("change", () => {
    const newTheme = themeSelect.value;
    Array.from(container.classList).forEach(cls => { if (cls.startsWith("theme-")) container.classList.remove(cls); });
    if (newTheme) container.classList.add(newTheme);
    localStorage.setItem("dashboardTheme", newTheme);
  });

  const actionModal = new bootstrap.Modal(document.getElementById('actionModal'));
  const confirmActionForm = document.getElementById('confirmActionForm');
  const actionModalBody = document.getElementById('actionModalBody');
  const confirmActionBtn = document.getElementById('confirmActionBtn');
  let currentAction = null, currentIdeaId = null;

  document.querySelectorAll(".open-action-modal").forEach(btn => {
    btn.addEventListener("click", (e) => {
      currentAction = e.currentTarget.dataset.action;
      currentIdeaId = e.currentTarget.dataset.id;
      let msg = "";
      confirmActionBtn.classList.toggle("btn-danger", currentAction === "delete");
      confirmActionBtn.classList.toggle("btn-warning", currentAction !== "delete");
      if (currentAction === "delete") msg = "Are you sure you want to <b>delete</b> this idea?";
      else if (currentAction === "archive") msg = "Are you sure you want to <b>archive</b> this idea?";
      else if (currentAction === "unarchive") msg = "Are you sure you want to <b>unarchive</b> this idea?";
      else msg = "Confirm your action.";
      actionModalBody.innerHTML = msg;
      actionModal.show();
    });
  });

  confirmActionForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    confirmActionBtn.disabled = true;
    confirmActionBtn.textContent = "Processing...";
    try {
      const response = await fetch("{% url 'idea_action' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ action: currentAction, idea_id: currentIdeaId }),
      });
      if (response.ok) location.reload();
      else {
        const errorData = await response.json();
        alert(`Error: ${errorData.error || 'An error occurred.'}`);
      }
    } catch {
      alert("Network error. Please try again.");
    } finally {
      confirmActionBtn.disabled = false;
      confirmActionBtn.textContent = "Confirm";
      actionModal.hide();
    }
  });

  function toggleThread(id) {
    const el = document.getElementById('thread-' + id);
    if (!el) return;
    if (el.style.opacity === '0' || el.style.opacity === '') {
      el.style.display = 'block';
      requestAnimationFrame(() => { el.style.transition = 'opacity 0.25s ease'; el.style.opacity = '1'; });
    } else {
      el.style.transition = 'opacity 0.25s ease';
      el.style.opacity = '0';
      el.addEventListener('transitionend', function handler() { el.style.display = 'none'; el.removeEventListener('transitionend', handler); });
    }
  }

  window.toggleThread = toggleThread;
});
</script>
{% endblock %}

{% extends "base.html" %}
{% block title %}Search{% endblock %}
{% load static %}

{% block content %}
<style>
  .search-container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
  }

  .search-input {
    width: 100%;
    padding: 12px 16px;
    border-radius: 10px;
    border: 2px solid #ccc;
    outline: none;
    font-size: 1rem;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .search-input:focus { border-color: #000; }

  .tabbar {
    display: flex;
    gap: 8px;
    align-items: center;
    margin-bottom: 20px;
  }
  .tab-btn {
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: transform .2s, box-shadow .2s;
  }
  .tab-btn.red { background: #f8d7da; color: #842029; }
  .tab-btn.yellow { background: #fff3cd; color: #856404; }
  .tab-btn.blue { background: #cfe2ff; color: #084298; }
  .tab-btn.is-active { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }

  .idea-card-gen{ background: #f8d7da;  color:black; }
  .users-card-gen{ background: #fff3cd; color:black; }
  .cate-card-gen{ background: #cfe2ff;  color:black; }
  .post-card-gen{ background: #e2f0d9; color:black; }

  .sort-select {
    margin-left: auto;
    padding: 8px 12px;
    border: 2px solid #ccc;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
  }

  .description {
    display: -webkit-box;
    -webkit-line-clamp: 3; /* limits to 3 lines */
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .tab-panel { min-height: 120px; }
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(280px,1fr)); gap: 20px; }
  .card-custom { border-radius: 12px; padding: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
  .card-custom h3 { margin-bottom: 8px; font-size: 1.2rem; }
  .meta { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9rem; color: #666; }
  .view-link { display: inline-block; margin-top: 10px; padding: 8px 14px; border-radius: 8px; background: #2196f3; color: white; text-decoration: none; }
</style>

<div class="search-container">
  <input class="search-input" id="search-input" type="text" placeholder="Search creations, people, categories…">

  <nav class="tabbar">
    <button class="tab-btn red is-active" data-tab="creations">Creations</button>
    <button class="tab-btn yellow" data-tab="users">People</button>
    <button class="tab-btn blue" data-tab="categories">Categories</button>
    <button class="tab-btn post-btn" data-tab="forum_posts">Forum Posts</button>
    <select id="sort-select" class="sort-select"></select>
    <span><select id="sort-order" class="sort-select">
        <option value="asc">Ascending</option>
        <option value="desc" selected>Descending</option>
    </select>
  </span>
  </nav>

  <section id="results" class="tab-panel">
    <p class="empty">Loading…</p>
  </section>
</div>

<script>
  const searchInput = document.getElementById("search-input");
  const results = document.getElementById("results");
  const tabButtons = document.querySelectorAll(".tab-btn");
  const sortSelect = document.getElementById("sort-select");
  const sortOrder = document.getElementById("sort-order");
  let activeTab = "creations";
  let typingTimer;
  let controller;
  let activeCategory = "";

  const sortOptions = {
    creations: [
      { value: "recent", label: "Most Recent" },
      { value: "popular", label: "Most Liked" },
      { value: "title", label: "Title A–Z" }
    ],
    users: [
      { value: "recent", label: "Recently Joined" },
      { value: "name", label: "Name A–Z" }
    ],
    categories: [
      { value: "count", label: "Most creations" },
      { value: "alpha", label: "A–Z" }
    ],
    forum_posts: [
      { value: "recent", label: "Most Recent" },
      { value: "title", label: "Title A–Z" }
    ]
  };

  function updateSortOptions() {
    sortSelect.innerHTML = sortOptions[activeTab]
      .map(opt => `<option value="${opt.value}">${opt.label}</option>`)
      .join("");
    // Reset sort order to default on tab change
    sortOrder.value = "desc";
  }

  const currentUser = "{{ request.user.username|escapejs }}";

  tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      tabButtons.forEach(b => b.classList.remove("is-active"));
      btn.classList.add("is-active");
      activeTab = btn.dataset.tab;
      activeCategory = "";
      results.className = "tab-panel";
      updateSortOptions();
      runSearch();
    });
  });

  sortSelect.addEventListener("change", runSearch);
  sortOrder.addEventListener("change", runSearch);

  searchInput.addEventListener("keyup", () => {
    clearTimeout(typingTimer);
    typingTimer = setTimeout(runSearch, 400);
  });

  async function runSearch() {
    const q = searchInput.value.trim();
    const sort = sortSelect.value;
    const order = sortOrder.value;

    if (controller) controller.abort();
    controller = new AbortController();

    let url = `/search/api/?q=${encodeURIComponent(q)}&tab=${activeTab}&sort=${sort}&order=${order}`;
    if (activeCategory) url += `&category=${encodeURIComponent(activeCategory)}`;

    try {
      const res = await fetch(url, { signal: controller.signal });
      if (!res.ok) throw new Error("Network error");
      const data = await res.json();
      renderResults(data);
    } catch (err) {
      if (err.name !== "AbortError") {
        results.innerHTML = `<p class="empty">Error loading results.</p>`;
      }
    }
  }

  function renderResults(data) {
    if (!data.length) {
      results.innerHTML = `<p class="empty">No ${activeTab} found.</p>`;
      return;
    }

    if (activeTab === "creations") {
      results.innerHTML = `<div class="cards-grid">${
        data.map(idea => `
        <a href="/idea/${idea.slug}/" style="text-decoration:none;">
          <article class="card-custom idea-card-gen">
            <h3>${idea.title}</h3>
            <p class="description">${idea.description || "No description available."}</p>
            <div class="meta">
              <span>${idea.likes} likes</span>
            </div>
          </article>
        </a>
        `).join("")
      }</div>`;
    } 
    else if (activeTab === "users") {
      results.innerHTML = `<div class="cards-grid">${
        data.map(u => {
          const profileUrl = u.username === currentUser ? "/dashboard/" : `/people/${u.username}/`;
          return `
          <a href="${profileUrl}">
            <article class="card-custom users-card-gen">
              <h3>@${u.username || "Unknown"}</h3>
              <p>${u.first_name || ""} ${u.last_name || ""}</p>
              <small>${u.email || ""}</small>
            </article>
          </a>
          `;
        }).join("")
      }</div>`;
    }
    else if (activeTab === "categories") {
      results.innerHTML = `<div class="cards-grid">${
        data.map(c => `
        <article class="card-custom category-card cate-card-gen" data-category="${c.category}">
          <h3>${c.category}</h3>
          <p>${c.count} creations</p>
        </article>
        `).join("")
      }</div>`;
      document.querySelectorAll(".category-card").forEach(card => {
        card.addEventListener("click", () => {
          activeTab = "creations";
          activeCategory = card.dataset.category;
          tabButtons.forEach(b => b.classList.remove("is-active"));
          document.querySelector(".tab-btn.red").classList.add("is-active");
          results.className = "tab-panel";
          updateSortOptions();
          runSearch();
        });
      });
    }
    else if (activeTab === "forum_posts") {
      results.innerHTML = `<div class="cards-grid">${
        data.map(post => `
        <a href="/forum/${post.title}/" style="text-decoration:none;">
          <article class="card-custom post-card-gen">
            <h3>${post.title}</h3>
            <p class="description">${post.content || "No content available."}</p>
            <div class="meta">
              <span>Category: ${post.category}</span>
            </div>
          </article>
        </a>
        `).join("")
      }</div>`;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    updateSortOptions();
    runSearch();
  });
</script>

{% endblock %}
  